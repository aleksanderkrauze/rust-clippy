#![allow(unused, clippy::redundant_clone, clippy::useless_vec)]
#![warn(clippy::result_as_ref_deref)]

use std::ffi::{CString, OsString};
use std::ops::{Deref, DerefMut};
use std::path::PathBuf;

fn main() {
    let mut res = Ok::<_, ()>(String::from("123"));

    let _ = res.clone().as_deref().map(str::len);

    #[rustfmt::skip]
    let _ = res.clone().as_deref()
        .map(str::len);

    let _ = res.as_deref_mut();

    let _ = res.as_deref();
    let _ = res.as_deref();
    let _ = res.as_deref_mut();
    let _ = res.as_deref_mut();
    let _ = Ok::<_, ()>(CString::new(vec![]).unwrap()).as_deref();
    let _ = Ok::<_, ()>(OsString::new()).as_deref();
    let _ = Ok::<_, ()>(PathBuf::new()).as_deref();
    let _ = Ok::<_, ()>(Vec::<()>::new()).as_deref();
    let _ = Ok::<_, ()>(Vec::<()>::new()).as_deref_mut();

    let _ = res.as_deref();
    let _ = res.clone().as_deref_mut().map(|x| x.len());

    let vc = vec![String::new()];
    let _ = Ok::<_, ()>(1_usize).as_ref().map(|x| vc[*x].as_str()); // should not be linted

    let _: Result<&str, &()> = Ok(&String::new()).as_ref().map(|x| x.as_str()); // should not be linted

    let _ = res.as_deref();
    let _ = res.as_deref_mut();

    let _ = res.as_deref();
}

#[clippy::msrv = "1.46"]
fn msrv_1_46() {
    let res = Ok::<_, ()>(String::from("123"));
    let _ = res.as_ref().map(String::as_str);
}

#[clippy::msrv = "1.47"]
fn msrv_1_47() {
    let res = Ok::<_, ()>(String::from("123"));
    let _ = res.as_deref();
}
